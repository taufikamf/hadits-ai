<!DOCTYPE html>
<html lang="id">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Hadis AI - Test Client</title>
		<style>
			body {
				font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
				max-width: 800px;
				margin: 0 auto;
				padding: 20px;
				background-color: #f5f5f5;
			}
			.container {
				background: white;
				padding: 30px;
				border-radius: 10px;
				box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
			}
			h1 {
				color: #2c3e50;
				text-align: center;
				margin-bottom: 30px;
			}
			.input-group {
				margin-bottom: 20px;
			}
			label {
				display: block;
				margin-bottom: 5px;
				font-weight: bold;
				color: #34495e;
			}
			input,
			textarea {
				width: 100%;
				padding: 10px;
				border: 2px solid #bdc3c7;
				border-radius: 5px;
				font-size: 14px;
				box-sizing: border-box;
			}
			input:focus,
			textarea:focus {
				outline: none;
				border-color: #3498db;
			}
			button {
				background-color: #3498db;
				color: white;
				padding: 12px 24px;
				border: none;
				border-radius: 5px;
				cursor: pointer;
				font-size: 16px;
				font-weight: bold;
				transition: background-color 0.3s;
			}
			button:hover:not(:disabled) {
				background-color: #2980b9;
			}
			button:disabled {
				background-color: #95a5a6;
				cursor: not-allowed;
			}
			.stop-btn {
				background-color: #e74c3c;
				margin-left: 10px;
			}
			.stop-btn:hover:not(:disabled) {
				background-color: #c0392b;
			}
			.response-container {
				margin-top: 20px;
				min-height: 200px;
				border: 2px solid #ecf0f1;
				border-radius: 5px;
				padding: 15px;
				background-color: #fafafa;
				overflow-y: auto;
				max-height: 500px;
			}
			.status {
				color: #f39c12;
				font-style: italic;
				margin: 5px 0;
			}
			.message {
				color: #2c3e50;
				line-height: 1.6;
				margin: 5px 0;
				white-space: pre-wrap;
			}
			.error {
				color: #e74c3c;
				font-weight: bold;
				margin: 5px 0;
			}
			.complete {
				color: #27ae60;
				font-weight: bold;
				margin: 10px 0;
			}
			.connection-status {
				text-align: center;
				padding: 10px;
				margin-bottom: 20px;
				border-radius: 5px;
				font-weight: bold;
			}
			.connected {
				background-color: #d5edda;
				color: #155724;
				border: 1px solid #c3e6cb;
			}
			.disconnected {
				background-color: #f8d7da;
				color: #721c24;
				border: 1px solid #f5c6cb;
			}
			.examples {
				margin-top: 20px;
				padding: 15px;
				background-color: #e8f4fd;
				border-radius: 5px;
				border-left: 4px solid #3498db;
			}
			.examples h3 {
				margin-top: 0;
				color: #2c3e50;
			}
			.example-btn {
				background-color: #ecf0f1;
				color: #2c3e50;
				padding: 5px 10px;
				margin: 2px;
				border: 1px solid #bdc3c7;
				border-radius: 3px;
				font-size: 12px;
				cursor: pointer;
			}
			.example-btn:hover {
				background-color: #d5dbdb;
			}
		</style>
	</head>
	<body>
		<div class="container">
			<h1>ðŸ•Œ Hadis AI - Test Client</h1>

			<div class="input-group">
				<label for="serverUrl">Server URL:</label>
				<input
					type="text"
					id="serverUrl"
					value="http://localhost:8000"
					placeholder="http://localhost:8000"
				/>
			</div>

			<div class="input-group">
				<label for="questionInput">Pertanyaan Hadits:</label>
				<textarea
					id="questionInput"
					rows="3"
					placeholder="Contoh: apa hukum riba?"
				></textarea>
			</div>

			<div style="text-align: center">
				<button id="askBtn" onclick="askQuestion()">Kirim Pertanyaan</button>
				<button
					id="stopBtn"
					class="stop-btn"
					onclick="stopStreaming()"
					disabled
				>
					Stop
				</button>
			</div>

			<div class="examples">
				<h3>Contoh Pertanyaan:</h3>
				<button class="example-btn" onclick="setQuestion('apa hukum riba?')">
					Hukum Riba
				</button>
				<button
					class="example-btn"
					onclick="setQuestion('bagaimana cara shalat malam?')"
				>
					Shalat Malam
				</button>
				<button
					class="example-btn"
					onclick="setQuestion('apa itu zakat fitrah?')"
				>
					Zakat Fitrah
				</button>
				<button
					class="example-btn"
					onclick="setQuestion('berikan hadis tentang mati syahid')"
				>
					Mati Syahid
				</button>
				<button
					class="example-btn"
					onclick="setQuestion('apa hukum minuman keras?')"
				>
					Minuman Keras
				</button>
			</div>

			<div id="connectionStatus" class="connection-status disconnected">
				Tidak terhubung
			</div>

			<div class="response-container" id="responseContainer">
				<div style="color: #7f8c8d; text-align: center; padding: 20px">
					Respons akan muncul di sini...
				</div>
			</div>
		</div>

		<script>
			let eventSource = null;
			let isStreaming = false;

			function setQuestion(question) {
				document.getElementById("questionInput").value = question;
			}

			function updateConnectionStatus(connected, message = "") {
				const statusEl = document.getElementById("connectionStatus");
				if (connected) {
					statusEl.className = "connection-status connected";
					statusEl.textContent = message || "Terhubung ke server";
				} else {
					statusEl.className = "connection-status disconnected";
					statusEl.textContent = message || "Tidak terhubung";
				}
			}

			function addMessage(type, text) {
				const container = document.getElementById("responseContainer");
				const messageEl = document.createElement("div");
				messageEl.className = type;
				messageEl.textContent = text;
				container.appendChild(messageEl);
				container.scrollTop = container.scrollHeight;
			}

			function clearResponse() {
				document.getElementById("responseContainer").innerHTML = "";
			}

			function askQuestion() {
				const serverUrl = document.getElementById("serverUrl").value.trim();
				const question = document.getElementById("questionInput").value.trim();

				if (!question) {
					alert("Silakan masukkan pertanyaan");
					return;
				}

				if (!serverUrl) {
					alert("Silakan masukkan URL server");
					return;
				}

				// Clear previous response
				clearResponse();

				// Update UI state
				isStreaming = true;
				document.getElementById("askBtn").disabled = true;
				document.getElementById("stopBtn").disabled = false;

				updateConnectionStatus(false, "Menghubungkan...");

				// Create EventSource for SSE
				const url = `${serverUrl}/ask`;

				// Send POST request to initiate streaming
				fetch(url, {
					method: "POST",
					headers: {
						"Content-Type": "application/json",
						Accept: "text/event-stream",
					},
					body: JSON.stringify({ question: question }),
				})
					.then((response) => {
						if (!response.ok) {
							throw new Error(
								`HTTP ${response.status}: ${response.statusText}`
							);
						}

						updateConnectionStatus(true, "Streaming dimulai...");

						// Read the stream
						const reader = response.body.getReader();
						const decoder = new TextDecoder();

						function readStream() {
							return reader.read().then(({ done, value }) => {
								if (done) {
									stopStreaming();
									return;
								}

								const chunk = decoder.decode(value);
								const lines = chunk.split("\n");

								for (const line of lines) {
									if (line.startsWith("event:")) {
										const eventType = line.substring(6).trim();
										// Will be used to determine message type
									} else if (line.startsWith("data:")) {
										const data = line.substring(5).trim();
										try {
											const parsedData = JSON.parse(data);

											// Determine message type based on the event
											if (chunk.includes("event: status")) {
												addMessage("status", `â³ ${parsedData}`);
											} else if (chunk.includes("event: message")) {
												addMessage("message", parsedData);
											} else if (chunk.includes("event: error")) {
												addMessage("error", `âŒ Error: ${parsedData}`);
											} else if (chunk.includes("event: complete")) {
												addMessage("complete", `âœ… ${parsedData}`);
											} else if (chunk.includes("event: retrieval_complete")) {
												addMessage("status", `ðŸ” ${parsedData}`);
											}
										} catch (e) {
											// If not JSON, just display as text
											addMessage("message", data);
										}
									}
								}

								if (isStreaming) {
									return readStream();
								}
							});
						}

						return readStream();
					})
					.catch((error) => {
						console.error("Streaming error:", error);
						addMessage("error", `Connection error: ${error.message}`);
						updateConnectionStatus(false, "Koneksi gagal");
						stopStreaming();
					});
			}

			function stopStreaming() {
				isStreaming = false;

				// Update UI state
				document.getElementById("askBtn").disabled = false;
				document.getElementById("stopBtn").disabled = true;

				updateConnectionStatus(false, "Streaming dihentikan");

				if (
					!document.getElementById("responseContainer").hasChildNodes() ||
					document.getElementById("responseContainer").children.length === 0
				) {
					addMessage("complete", "Streaming selesai");
				}
			}

			// Check server health on page load
			window.onload = function () {
				const serverUrl = document.getElementById("serverUrl").value;
				fetch(`${serverUrl}/health`)
					.then((response) => response.json())
					.then((data) => {
						updateConnectionStatus(
							true,
							`Server: ${data.status} (Retrieval: ${data.retrieval_status}, LLM: ${data.llm_status})`
						);
					})
					.catch((error) => {
						updateConnectionStatus(false, "Server tidak dapat dijangkau");
					});
			};

			// Allow Enter key to submit
			document
				.getElementById("questionInput")
				.addEventListener("keydown", function (e) {
					if (e.key === "Enter" && e.ctrlKey) {
						askQuestion();
					}
				});
		</script>
	</body>
</html>
